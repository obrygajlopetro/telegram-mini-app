
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Витрина</title>
  <style>
    body {
      margin: 0;
      background: #121212;
      color: white;
      font-family: sans-serif;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: none;
      background: #444;
      color: white;
      cursor: pointer;
    }
    .loader, .order-loader, .payment-screen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .progress-container {
      width: 100%;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      height: 10px;
    }
    .progress-bar {
      width: 0;
      height: 100%;
      background: white;
    }
    .blurred {
      filter: blur(6px);
      pointer-events: none;
      user-select: none;
    }
    .yellow-box {
      background: #26201f;
      border: 1px solid #9c0602;
      border-radius: 8px;
      padding: 10px;
      color: #9c0602;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<!-- Блок выбора города и метро -->

<div id="city-metro-modal" class="modal">
  <img src="https://via.placeholder.com/128x64" alt="Баннер" style="width:128px;height:64px;object-fit:contain;margin-bottom:10px;">
  <h2 style="font-size:16px;margin:10px 0;">Выбери город и станцию метро</h2>
  <select id="city-select" style="width:100%;padding:10px;margin:10px 0;border-radius:5px;border:none;background:#333;color:white;">
    <option value="moscow">Москва</option>
    <option value="spb">Санкт-Петербург</option>
  </select>
  <select id="metro-select" style="width:100%;padding:10px;margin:10px 0;border-radius:5px;border:none;background:#333;color:white;"></select>
  <button id="confirm-btn" class="button">Подтвердить</button>
</div>

<!-- Лоадбар -->
<div id="loader" class="loader" style="display:none;">
  <p id="loader-text">Загрузка витрины...</p>
  <div class="progress-container">
    <div id="progress-bar" class="progress-bar"></div>
  </div>
</div>

<!-- Витрина товаров -->
<div id="storefront" style="display:none; padding:20px;">
  <h2 id="store-title" style="text-align:center;">Витрина товаров</h2>
  <div id="product-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;margin-top:20px;"></div>
</div>

<!-- Лоадбар после покупки -->
<div id="order-loader" class="order-loader" style="display:none;">
  <p id="order-loader-text">Загрузка данных по заказу...</p>
  <div class="progress-container">
    <div id="order-progress-bar" class="progress-bar"></div>
  </div>
</div>

<!-- Экран оплаты -->
<div id="payment-screen" class="payment-screen" style="display:none;"></div>

<script>
  const citySelect = document.getElementById("city-select");
  const metroSelect = document.getElementById("metro-select");
  const modal = document.getElementById("city-metro-modal");
  const loader = document.getElementById("loader");
  const loaderText = document.getElementById("loader-text");
  const progressBar = document.getElementById("progress-bar");
  const storefront = document.getElementById("storefront");
  const productGrid = document.getElementById("product-grid");
  const storeTitle = document.getElementById("store-title");
  const paymentScreen = document.getElementById("payment-screen");
  let selectedMetro = "";
  let savedOrderId = null;
  let lastCheckTime = null;

  const products = [
    "Красный кубик", "Синий шар", "Жёлтый треугольник", "Зелёный цилиндр",
    "Оранжевая пирамида", "Сиреневая звезда", "Белый конус", "Чёрный куб",
    "Прозрачный шар", "Неоновый прямоугольник"
  ];

  const metroStations = {
    moscow: ["Охотный ряд", "Тверская", "Арбатская"],
    spb: ["Гостиный двор", "Маяковская", "Сенная площадь"]
  };

  function updateMetroOptions(city) {
    metroSelect.innerHTML = "";
    metroStations[city].forEach(station => {
      const option = document.createElement("option");
      option.value = station;
      option.textContent = station;
      metroSelect.appendChild(option);
    });
  }

  citySelect.addEventListener("change", () => {
    updateMetroOptions(citySelect.value);
  });

  document.addEventListener("DOMContentLoaded", () => {
    updateMetroOptions(citySelect.value);
  });

  document.getElementById("confirm-btn").addEventListener("click", () => {
    selectedMetro = metroSelect.value;
    modal.style.display = "none";
    loaderText.textContent = `Загрузка витрины для станции метро ${selectedMetro}`;
    loader.style.display = "block";
    let progress = 0;
    const duration = 3000 + Math.random() * 7000;
    const start = Date.now();

    function animateLoader() {
      progress = (Date.now() - start) / duration * 100;
      progressBar.style.width = Math.min(progress, 100) + "%";
      if (progress < 100) {
        requestAnimationFrame(animateLoader);
      } else {
        loader.style.display = "none";
        storeTitle.textContent = `Витрина товаров для станции метро ${selectedMetro}`;
        renderProducts();
        storefront.style.display = "block";
      }
    }
    animateLoader();
  });

  function renderProducts() {
    productGrid.innerHTML = "";
    for (let i = 0; i < 10; i++) {
      const card = document.createElement("div");
      card.style.background = "#1e1e1e";
      card.style.borderRadius = "10px";
      card.style.padding = "10px";
      card.innerHTML = `
        <img src="https://via.placeholder.com/150" style="width:100%;border-radius:10px;object-fit:cover;margin-bottom:10px;" />
        <h3 style="margin:0 0 5px 0; font-size:14px;">${products[i]}</h3>
        <p style="margin:0 0 5px 0;">Цена: ${(1000 + i * 100)}₽</p>
        <select class="qty-select" style="width:100%;padding:5px;margin-bottom:5px;background:#333;color:white;border:none;border-radius:5px;">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
        <select class="delivery-method" style="width:100%;padding:5px;margin-bottom:5px;background:#333;color:white;border:none;border-radius:5px;">
          <option>Адресная доставка</option><option>Самовывоз</option><option>Почта</option>
        </select>
        <button class="buy-btn button">Купить</button>
      `;
      productGrid.appendChild(card);
    }
  }

  function showOrderLoader(productName, price, qty, deliveryMethod) {
    savedOrderId = savedOrderId || Math.floor(100000 + Math.random() * 900000);
    const orderLoader = document.getElementById("order-loader");
    const orderText = document.getElementById("order-loader-text");
    const orderProgress = document.getElementById("order-progress-bar");
    orderText.textContent = `Загрузка данных по заказу #${savedOrderId}`;
    document.body.classList.add("blurred");
    orderLoader.style.display = "block";
    orderProgress.style.width = "0%";
    const duration = 3000 + Math.random() * 4000;
    const start = Date.now();
    function updateProgress() {
      const percent = Math.min((Date.now() - start) / duration * 100, 100);
      orderProgress.style.width = `${percent}%`;
      if (percent < 100) {
        requestAnimationFrame(updateProgress);
      } else {
        orderLoader.style.display = "none";
        document.body.classList.remove("blurred");
        showPaymentScreen(productName, price, qty, deliveryMethod);
      }
    }
    requestAnimationFrame(updateProgress);
  }

  function showPaymentScreen(name, price, qty, deliveryMethod) {
    const sum = price * qty;
    const card = "1234 5678 9012 3456";
    const timeNow = new Date().toLocaleTimeString();
    const dateNow = new Date().toLocaleDateString();
    paymentScreen.innerHTML = `
      <h3>Оплата заказа</h3>
      <p><strong>Время и дата:</strong> ${timeNow}, ${dateNow}</p>
      <p><strong>ID заказа:</strong> ${savedOrderId}</p>
      <p><strong>Позиция:</strong> ${name}</p>
      <p><strong>Метро:</strong> ${selectedMetro}</p>
      <p><strong>Метод доставки:</strong> ${deliveryMethod}</p>
      <p><strong>Сумма:</strong> ${sum}₽</p>
      <p><strong>Реквизиты для оплаты:</strong> ${card}</p>
      <p id="timer"></p>
      <button id="check-payment-btn" class="button">Проверить оплату</button>
      <button id="restart-btn" class="button">Создать заказ заново</button>
      <div id="payment-message"></div>
    `;
    storefront.style.display = "none";
    paymentScreen.style.display = "block";

    const timer = document.getElementById("timer");
    let remaining = 15 * 60;
    setInterval(() => {
      if (remaining > 0) {
        const min = Math.floor(remaining / 60);
        const sec = remaining % 60;
        timer.textContent = `До истечения времени оплаты: ${min}:${sec.toString().padStart(2, '0')}`;
        remaining--;
      }
    }, 1000);
    
    document.getElementById("check-payment-btn").onclick = () => {
      const messageBox = document.getElementById("payment-message");
      messageBox.innerHTML = `<p>Проверка статуса оплаты по заказу #${savedOrderId}...</p>`;
      const delay = 2000 + Math.random() * 4000;
      setTimeout(() => {
        lastCheckTime = new Date().toLocaleTimeString();
        messageBox.innerHTML = `<div class='yellow-box'>Оплата на сумму ${sum}₽ по реквизитам ${card} не обнаружена. Убедитесь, что платёж проведён банком или отправьте боту чек об оплате. Последнее обновление ${lastCheckTime}</div>`;
      }, delay);
    };
    
    document.getElementById("restart-btn").onclick = () => {
      savedOrderId = null;
      storefront.style.display = "none";
      paymentScreen.style.display = "none";
      modal.style.display = "block";
    };
  }

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("buy-btn")) {
      const card = e.target.closest("div");
      const name = card.querySelector("h3").textContent;
      const price = parseInt(card.querySelector("p").textContent.match(/\d+/)[0]);
      const qty = parseInt(card.querySelector(".qty-select").value);
      const method = card.querySelector(".delivery-method").value;
      showOrderLoader(name, price, qty, method);
    }
  });
</script>
</body>
</html>
